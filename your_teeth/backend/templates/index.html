<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ¦· Dental AI Diagnosis System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", system-ui, sans-serif;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
      .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body class="py-8 px-4">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-10 fade-in">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
          <i class="fas fa-tooth mr-4"></i>Dental AI Diagnosis System
        </h1>
        <p class="text-xl text-white opacity-90">
          Upload a dental image for AI-powered analysis with Grad-CAM
          visualization
        </p>
      </div>

      <!-- Main Card -->
      <div class="glass-card p-6 md:p-8 mb-8 fade-in">
        <!-- Upload Section -->
        <div id="upload-section">
          <h2 class="text-2xl font-bold gradient-text mb-6">
            <i class="fas fa-upload mr-3"></i>Upload Dental Image
          </h2>

          <div
            class="border-4 border-dashed border-gray-300 rounded-2xl p-8 text-center mb-6 transition-all duration-300 hover:border-blue-400 hover:bg-blue-50"
            id="drop-area"
          >
            <i class="fas fa-tooth text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 text-lg mb-4">
              Drag & drop your dental image here, or click to browse
            </p>
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              class="hidden"
            />
            <button
              onclick="document.getElementById('imageInput').click()"
              class="bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-8 rounded-full hover:opacity-90 transition duration-300 pulse hover:shadow-lg"
            >
              <i class="fas fa-search mr-2"></i>Select Image
            </button>
            <p class="text-sm text-gray-500 mt-4">
              Supported: JPG, PNG, JPEG â€¢ Max 10MB
            </p>
          </div>

          <!-- File Preview -->
          <div id="filePreview" class="hidden fade-in mb-6">
            <div
              class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-200"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <i class="fas fa-file-image text-3xl text-green-500 mr-3"></i>
                  <div>
                    <p id="fileName" class="font-bold text-gray-800"></p>
                    <p id="fileSize" class="text-sm text-gray-600"></p>
                  </div>
                </div>
                <div class="flex gap-3">
                  <button
                    onclick="clearSelection()"
                    class="text-red-500 hover:text-red-700 hover:scale-110 transition"
                  >
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>
              <div class="mt-4">
                <img
                  id="imagePreview"
                  class="max-w-xs mx-auto rounded-lg shadow"
                />
              </div>
            </div>
          </div>

          <!-- Analyze Button -->
          <div class="text-center">
            <button
              id="analyzeBtn"
              onclick="analyzeImage()"
              class="bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-4 px-12 rounded-full text-lg hover:opacity-90 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transform hover:-translate-y-1"
              disabled
            >
              <i class="fas fa-microscope mr-3"></i>Analyze with AI
            </button>
            <p class="text-gray-600 mt-3">
              <i class="fas fa-info-circle mr-1"></i>
              AI will detect: Caries, Calculus, Healthy, or Discoloration
            </p>
          </div>
        </div>

        <!-- Loading -->
        <div id="loadingSpinner" class="hidden text-center py-12 fade-in">
          <div
            class="inline-block animate-spin rounded-full h-20 w-20 border-t-4 border-blue-500 border-r-4 border-transparent mb-6"
          ></div>
          <h3 class="text-2xl font-bold text-gray-800 mb-2">
            AI is Analyzing...
          </h3>
          <p class="text-gray-600">Processing image with neural network</p>
          <div
            class="mt-6 w-64 h-2 bg-gray-200 rounded-full mx-auto overflow-hidden"
          >
            <div
              class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-pulse"
              style="width: 80%"
            ></div>
          </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
          <h2 class="text-2xl font-bold gradient-text mb-6 fade-in">
            <i class="fas fa-chart-bar mr-3"></i>Analysis Results
          </h2>

          <!-- Diagnosis Card -->
          <div
            class="bg-white rounded-2xl p-6 mb-8 shadow-lg border-l-8 border-blue-500 fade-in"
          >
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8"
            >
              <div>
                <h3 class="text-2xl font-bold text-gray-800">
                  <i class="fas fa-diagnoses mr-2"></i>AI Diagnosis
                </h3>
                <p id="diagnosisMessage" class="text-gray-700 text-lg mt-2"></p>
              </div>
              <div class="mt-4 md:mt-0">
                <span
                  id="confidenceBadge"
                  class="px-6 py-3 rounded-full text-white font-bold text-xl shadow-lg"
                >
                </span>
              </div>
            </div>

            <!-- Images -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
              <!-- Original Image -->
              <div class="text-center">
                <h4 class="font-bold text-gray-700 mb-4 text-lg">
                  <i class="fas fa-image mr-2"></i>Original Image
                </h4>
                <div
                  class="relative rounded-xl border-4 border-gray-200 overflow-hidden shadow-lg"
                >
                  <img
                    id="originalImage"
                    class="w-full h-80 object-contain bg-gray-50 p-2"
                  />
                </div>
              </div>

              <!-- Grad-CAM Image -->
              <div class="text-center">
                <h4 class="font-bold text-gray-700 mb-4 text-lg">
                  <i class="fas fa-fire mr-2"></i>Grad-CAM Visualization
                </h4>
                <div
                  class="relative rounded-xl border-4 border-gray-200 overflow-hidden shadow-lg"
                >
                  <div id="gradcamContainer" class="relative">
                    <img
                      id="gradcamImage"
                      class="w-full h-80 object-contain bg-gray-50 p-2"
                    />
                  </div>
                </div>
                <p id="gradcamDescription" class="text-sm text-gray-600 mt-3">
                  <i class="fas fa-info-circle mr-1"></i>
                  Green areas show where AI detected disease patterns
                </p>
              </div>
            </div>
          </div>

          <!-- Probabilities -->
          <div
            class="bg-white rounded-2xl p-8 shadow-lg mb-8 fade-in"
            style="animation-delay: 0.2s"
          >
            <h3 class="text-2xl font-bold text-gray-800 mb-8">
              <i class="fas fa-chart-line mr-2"></i>Detailed Probabilities
            </h3>
            <div id="probabilityBars" class="space-y-8">
              <!-- Will be populated by JS -->
            </div>
          </div>

          <!-- Next Steps -->
          <div
            class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8 border border-blue-200 fade-in"
            style="animation-delay: 0.3s"
          >
            <h3 class="text-2xl font-bold text-blue-800 mb-6">
              <i class="fas fa-stethoscope mr-2"></i>Recommended Next Steps
            </h3>
            <div id="nextSteps" class="space-y-4">
              <!-- Will be populated by JS -->
            </div>
            <div class="mt-8 p-4 bg-white rounded-lg border border-blue-100">
              <p class="text-sm text-gray-700 flex items-start">
                <i
                  class="fas fa-exclamation-triangle text-amber-500 mr-2 mt-1 text-lg"
                ></i>
                <span>
                  <strong class="text-red-600">Disclaimer:</strong> This AI
                  analysis is for informational purposes only. Always consult a
                  qualified dental professional for diagnosis and treatment.
                </span>
              </p>
            </div>
          </div>

          <!-- New Analysis Button -->
          <div class="text-center mt-10 fade-in" style="animation-delay: 0.4s">
            <button
              onclick="resetAnalysis()"
              class="bg-gradient-to-r from-gray-600 to-gray-800 text-white font-bold py-4 px-10 rounded-full hover:opacity-90 transition duration-300 hover:shadow-lg transform hover:-translate-y-1 text-lg"
            >
              <i class="fas fa-redo mr-3"></i>Analyze Another Image
            </button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center text-white opacity-80 mt-12">
        <p class="flex items-center justify-center text-lg">
          <i class="fas fa-heart text-red-400 mr-3"></i>
          Dental AI Diagnosis System â€¢ Using TensorFlow & Grad-CAM
        </p>
        <p class="text-sm mt-3">
          <i class="fas fa-shield-alt text-green-400 mr-2"></i>
          Images are processed locally and automatically deleted after analysis
        </p>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      let selectedFile = null;
      let originalImageUrl = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Dental AI System loaded");
        checkAPIHealth();
      });

      // File selection
      document
        .getElementById("imageInput")
        .addEventListener("change", function (e) {
          if (e.target.files.length > 0) {
            handleSelectedFile(e.target.files[0]);
          }
        });

      // Drag & drop
      const dropArea = document.getElementById("drop-area");
      ["dragenter", "dragover"].forEach((event) => {
        dropArea.addEventListener(event, function (e) {
          e.preventDefault();
          this.classList.add("border-blue-500", "bg-blue-50");
        });
      });

      ["dragleave", "drop"].forEach((event) => {
        dropArea.addEventListener(event, function (e) {
          e.preventDefault();
          this.classList.remove("border-blue-500", "bg-blue-50");
          if (event === "drop" && e.dataTransfer.files.length > 0) {
            handleSelectedFile(e.dataTransfer.files[0]);
          }
        });
      });

      function handleSelectedFile(file) {
        if (!file.type.startsWith("image/")) {
          showToast("Please select an image file", "error");
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          showToast("File size should be less than 10MB", "error");
          return;
        }

        selectedFile = file;

        // Update preview
        document.getElementById("fileName").textContent = file.name;
        document.getElementById("fileSize").textContent = formatFileSize(
          file.size,
        );

        const reader = new FileReader();
        reader.onload = function (e) {
          const previewImg = document.getElementById("imagePreview");
          previewImg.src = e.target.result;
          originalImageUrl = e.target.result;
          document.getElementById("originalImage").src = e.target.result;
        };
        reader.readAsDataURL(file);

        document.getElementById("filePreview").classList.remove("hidden");
        document.getElementById("analyzeBtn").disabled = false;
        showToast("Image selected successfully", "success");
      }

      function clearSelection() {
        selectedFile = null;
        originalImageUrl = null;
        document.getElementById("imageInput").value = "";
        document.getElementById("filePreview").classList.add("hidden");
        document.getElementById("analyzeBtn").disabled = true;
        showToast("Selection cleared", "info");
      }

      async function analyzeImage() {
        if (!selectedFile) return;

        // Show loading
        document.getElementById("upload-section").classList.add("hidden");
        document.getElementById("loadingSpinner").classList.remove("hidden");
        document.getElementById("resultsSection").classList.add("hidden");

        const formData = new FormData();
        formData.append("file", selectedFile);

        try {
          showToast("Analyzing image...", "info");
          const response = await fetch("/api/analyze", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          // Hide loading
          document.getElementById("loadingSpinner").classList.add("hidden");

          if (result.status === "success") {
            showToast("Analysis complete!", "success");
            displayResults(result);
          } else {
            showToast("Error: " + (result.error || "Analysis failed"), "error");
            resetAnalysis();
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Network error. Please try again.", "error");
          resetAnalysis();
        }
      }

      function displayResults(data) {
        const pred = data.prediction;
        const confidence = (pred.confidence * 100).toFixed(1);

        // Set diagnosis
        document.getElementById("diagnosisMessage").textContent = pred.message;

        // Set confidence badge
        const badge = document.getElementById("confidenceBadge");
        badge.textContent = `${confidence}% Confidence`;
        if (confidence >= 80) {
          badge.className =
            "px-6 py-3 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-xl shadow-lg";
        } else if (confidence >= 60) {
          badge.className =
            "px-6 py-3 rounded-full bg-gradient-to-r from-yellow-500 to-amber-600 text-white font-bold text-xl shadow-lg";
        } else {
          badge.className =
            "px-6 py-3 rounded-full bg-gradient-to-r from-red-500 to-pink-600 text-white font-bold text-xl shadow-lg";
        }

        // Set images
        const timestamp = new Date().getTime();
        document.getElementById("originalImage").src =
          `/static/${data.images.original}?t=${timestamp}`;

        const gradcamImg = document.getElementById("gradcamImage");
        gradcamImg.src = `/static/${data.images.gradcam}?t=${timestamp}`;

        // Add green overlay if heatmap data exists
        if (data.heatmap_data && data.heatmap_data.regions.length > 0) {
          createGreenOverlay(gradcamImg, data.heatmap_data.regions);
          document.getElementById("gradcamDescription").innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    ðŸŸ¢ <strong>${data.heatmap_data.num_regions} disease regions</strong> detected by AI
                `;
        }

        // Create probability bars
        createProbabilityBars(pred.all_probabilities, pred.class);

        // Create next steps
        createNextSteps(pred.class, pred.confidence);

        // Show results
        setTimeout(() => {
          document.getElementById("resultsSection").classList.remove("hidden");
        }, 300);
      }
      function createGreenOverlay(imageElement, regions) {
        const container = imageElement.parentElement;

        // Remove existing overlay
        const existing = container.querySelector(".green-overlay");
        if (existing) existing.remove();

        // Create overlay container
        const overlay = document.createElement("div");
        overlay.className =
          "green-overlay absolute top-0 left-0 w-full h-full pointer-events-none";
        overlay.style.zIndex = "10";

        // Create style for pulsing effect
        const style = document.createElement("style");
        style.textContent = `
        @keyframes pulse-green {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.9; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
        }
    `;
        document.head.appendChild(style);

        // Add green circles for each region
        regions.forEach((region, index) => {
          const circle = document.createElement("div");
          circle.className = "absolute rounded-full";
          circle.style.left = `${region.x}%`;
          circle.style.top = `${region.y}%`;
          circle.style.width = `${region.radius * 2}px`;
          circle.style.height = `${region.radius * 2}px`;
          circle.style.backgroundColor = `rgba(0, 255, 0, ${region.intensity * 0.6})`;
          circle.style.border = `2px solid rgba(0, 255, 0, ${region.intensity * 0.9})`;
          circle.style.transform = "translate(-50%, -50%)";
          circle.style.boxShadow = `0 0 ${region.radius * 3}px rgba(0, 255, 0, ${region.intensity})`;
          circle.style.animation = `pulse-green 1.5s infinite ${index * 0.3}s`;

          // Add number label
          const label = document.createElement("div");
          label.className = "absolute text-white font-bold text-sm";
          label.textContent = `${index + 1}`;
          label.style.left = "50%";
          label.style.top = "50%";
          label.style.transform = "translate(-50%, -50%)";
          label.style.textShadow = "0 1px 3px rgba(0,0,0,0.8)";

          circle.appendChild(label);
          overlay.appendChild(circle);
        });

        // Add legend
        if (regions.length > 0) {
          const legend = document.createElement("div");
          legend.className =
            "absolute bottom-3 left-3 bg-black/70 text-white text-xs px-3 py-2 rounded-lg";
          legend.innerHTML = `
            <div class="flex items-center mb-1">
                <div class="w-3 h-3 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                <span>ðŸŸ¢ ${regions.length} disease regions detected</span>
            </div>
            <div class="text-xs opacity-80">Green areas show where AI focused</div>
        `;
          overlay.appendChild(legend);
        }

        container.appendChild(overlay);
      }
      function createProbabilityBars(probabilities, predictedClass) {
        const container = document.getElementById("probabilityBars");
        container.innerHTML = "";

        const diseases = [
          {
            name: "caries",
            display: "Dental Caries",
            icon: "fas fa-tooth",
            color: "text-red-600",
          },
          {
            name: "calculus",
            display: "Dental Calculus",
            icon: "fas fa-stone",
            color: "text-amber-600",
          },
          {
            name: "healthy",
            display: "Healthy Teeth",
            icon: "fas fa-heart",
            color: "text-green-600",
          },
          {
            name: "discoloration",
            display: "Tooth Discoloration",
            icon: "fas fa-palette",
            color: "text-blue-600",
          },
        ];

        diseases.forEach((disease, index) => {
          const prob = (probabilities[disease.name] * 100).toFixed(1);
          const isPredicted = predictedClass === disease.name;

          const barHtml = `
                    <div class="fade-in" style="animation-delay: ${0.1 * index}s">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center ${disease.color} ${isPredicted ? "font-bold" : ""}">
                                <i class="${disease.icon} mr-3 text-xl"></i>
                                <span class="text-lg">${disease.display}</span>
                                ${isPredicted ? '<i class="fas fa-crown ml-3 text-yellow-500"></i>' : ""}
                            </div>
                            <div class="flex items-center">
                                <span class="text-xl font-bold ${disease.color} mr-3">${prob}%</span>
                                ${isPredicted ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : ""}
                            </div>
                        </div>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000 ${
                              isPredicted
                                ? "bg-gradient-to-r from-red-500 to-orange-500"
                                : prob > 30
                                  ? "bg-gradient-to-r from-yellow-400 to-orange-400"
                                  : prob > 10
                                    ? "bg-gradient-to-r from-green-400 to-teal-400"
                                    : "bg-gradient-to-r from-gray-300 to-gray-400"
                            }" style="width: 0%" data-width="${prob}%"></div>
                        </div>
                    </div>
                `;

          container.innerHTML += barHtml;
        });

        // Animate bars
        setTimeout(() => {
          document.querySelectorAll("[data-width]").forEach((bar) => {
            bar.style.width = bar.getAttribute("data-width");
          });
        }, 100);
      }

      function createNextSteps(disease, confidence) {
        const steps = {
          caries: [
            "Schedule dental appointment within 1 week",
            "Avoid sugary foods and drinks",
            "Use fluoride toothpaste",
            "Consider dental sealants",
          ],
          calculus: [
            "Professional dental cleaning needed",
            "Improve brushing technique",
            "Use tartar-control toothpaste",
            "Regular flossing",
          ],
          healthy: [
            "Continue regular oral hygiene",
            "Schedule routine check-up in 6 months",
            "Maintain balanced diet",
            "Avoid tobacco products",
          ],
          discoloration: [
            "Consult for teeth whitening options",
            "Reduce coffee/tea consumption",
            "Quit smoking if applicable",
            "Professional cleaning",
          ],
        };

        const container = document.getElementById("nextSteps");
        const diseaseSteps = steps[disease] || steps.healthy;

        container.innerHTML = diseaseSteps
          .map(
            (step, i) => `
                <div class="flex items-center p-4 bg-white rounded-xl border border-blue-100 fade-in" 
                     style="animation-delay: ${0.15 * i}s">
                    <i class="fas fa-check-circle text-green-500 mr-4 text-xl"></i>
                    <span class="text-gray-800 text-lg">${step}</span>
                </div>
            `,
          )
          .join("");
      }

      function resetAnalysis() {
        selectedFile = null;
        originalImageUrl = null;
        document.getElementById("imageInput").value = "";
        document.getElementById("filePreview").classList.add("hidden");
        document.getElementById("analyzeBtn").disabled = true;
        document.getElementById("upload-section").classList.remove("hidden");
        document.getElementById("resultsSection").classList.add("hidden");
        showToast("Ready for new analysis", "info");
      }

      // Utility functions
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl text-white z-50 fade-in ${
          type === "error"
            ? "bg-red-500"
            : type === "success"
              ? "bg-green-500"
              : "bg-blue-500"
        }`;

        const icon =
          type === "error"
            ? "exclamation-triangle"
            : type === "success"
              ? "check-circle"
              : "info-circle";

        toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icon} mr-3 text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add(
            "opacity-0",
            "transition-opacity",
            "duration-300",
          );
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      async function checkAPIHealth() {
        try {
          const response = await fetch("/api/health");
          const data = await response.json();
          console.log("API Health:", data);
          if (data.model_loaded) {
            showToast("AI Model loaded successfully!", "success");
          }
        } catch (error) {
          console.warn("API not responding yet:", error);
        }
      }
    </script>
  </body>
</html>
